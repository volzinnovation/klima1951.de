<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avro Climate Data Plotter</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and its date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- avro-js for reading Avro files -->
    <script src="https://cdn.jsdelivr.net/npm/avro-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
            <div class="p-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2">Climate Data Visualizer</h1>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Displaying climate data from <strong>1951.avro</strong> using a defined schema.</p>

                <!-- Status and Chart Section -->
                <div id="status" class="text-center p-4 text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    Attempting to load data...
                </div>
                <div class="mt-6">
                    <canvas id="climateChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Avro Schema Definition (as provided in the original Python script) ---
        const schema = {
            "type": "record",
            "name": "ClimateData",
            "fields": [
                { "name": "time", "type": "int", "logicalType": "date" },
                { "name": "hurs", "type": ["null", "float"] },
                { "name": "pr", "type": ["null", "float"] },
                { "name": "tas", "type": ["null", "float"] },
                { "name": "tasmax", "type": ["null", "float"] },
                { "name": "tasmin", "type": ["null", "float"] }
            ]
        };

        const statusEl = document.getElementById('status');
        const ctx = document.getElementById('climateChart').getContext('2d');
        let climateChart;

        /**
         * Fetches and processes the static Avro file on page load.
         */
        async function loadStaticAvroFile() {
          const fileName = '1951.avro';
          statusEl.textContent = `Loading data from ${fileName}...`;
          try {
            const response = await fetch(fileName);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} - Could not find ${fileName}.`);
            }
            const buffer = await response.arrayBuffer();
            // We no longer need to pass the schema, as avsc reads it from the container file
            parseAvroData(buffer); // Buffer.from(buffer)); // Use Buffer, which avsc prefers
          } catch (error) {
            console.error("Error loading file:", error);
            statusEl.textContent = `Error: ${error.message}. Please ensure '1951.avro' is in the same directory.`;
            statusEl.classList.add('text-red-500', 'dark:text-red-400');
          }
        }

      function parseAvroData(buffer) {
        const records = [];
        try {
            // avsc's createFileDecoder is designed for Avro container files (like yours)
            const decoder = avsc.createFileDecoder(buffer);
            decoder.on('data', (record) => {
                // This event fires for each record successfully decoded
                records.push(record);
            });
            decoder.on('end', () => {
                // This event fires when the entire file has been read
                if (records.length === 0) {
                    statusEl.textContent = 'Avro file was read, but it contains no records.';
                    return;
                }
                statusEl.textContent = `Successfully processed ${records.length} records. Rendering chart...`;
                prepareChartData(records);
            });
        } catch (error) {
            console.error('Avro parsing error:', error);
            statusEl.textContent = `Failed to parse Avro file. The file may be corrupt. Error: ${error.message}`;
            statusEl.classList.add('text-red-500', 'dark:text-red-400');
        }
    }

  

    /**
     * Converts the Avro date (days since epoch) to a JavaScript Date object.
     * @param {number} avroDate - The number of days since 1970-01-01.
     * @returns {Date} The corresponding JavaScript Date object.
     */
    function convertAvroDate(avroDate) {
        const epoch = new Date('1970-01-01T00:00:00Z');
        epoch.setDate(epoch.getDate() + avroDate);
        return epoch;
    }
        /**
         * Processes the decoded records and creates the chart.
         * @param {Array<Object>} records - The array of records from the Avro file.
         */
        function prepareChartData(records) {
            const labels = records.map(r => convertAvroDate(r.time));
            const tasData = records.map(r => r.tas);
            const tasminData = records.map(r => r.tasmin);
            const tasmaxData = records.map(r => r.tasmax);
            const hursData = records.map(r => r.hurs);
            const prData = records.map(r => r.pr);

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Avg Temperature (tas)',
                        data: tasData,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        yAxisID: 'y',
                        borderWidth: 2,
                        pointRadius: 1,
                    },
                    {
                        label: 'Min Temperature (tasmin)',
                        data: tasminData,
                        borderColor: 'rgba(147, 197, 253, 1)',
                        backgroundColor: 'rgba(147, 197, 253, 0.5)',
                        yAxisID: 'y',
                        borderWidth: 1.5,
                        pointRadius: 1,
                    },
                    {
                        label: 'Max Temperature (tasmax)',
                        data: tasmaxData,
                        borderColor: 'rgba(30, 64, 175, 1)',
                        backgroundColor: 'rgba(30, 64, 175, 0.5)',
                        yAxisID: 'y',
                        borderWidth: 1.5,
                        pointRadius: 1,
                    },
                    {
                        label: 'Humidity (hurs)',
                        data: hursData,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        yAxisID: 'y1',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 1,
                    },
                    {
                        label: 'Precipitation (pr)',
                        data: prData,
                        borderColor: 'rgba(6, 95, 70, 1)',
                        backgroundColor: 'rgba(6, 95, 70, 0.5)',
                        yAxisID: 'y1',
                        borderWidth: 2,
                        pointRadius: 1,
                    }
                ]
            };
            
            if (climateChart) {
                climateChart.destroy();
            }

            renderChart(data);
        }

        /**
         * Renders the chart using the provided data.
         * @param {Object} data - The data object for Chart.js.
         */
        function renderChart(data) {
            climateChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Climate Data Over Time (1951)',
                            font: { size: 18 }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'PPP'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature (Â°C)',
                                color: 'rgba(59, 130, 246, 1)'
                            },
                            ticks: {
                                color: 'rgba(59, 130, 246, 1)'
                            },
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humidity / Precipitation',
                                color: 'rgba(16, 185, 129, 1)'
                            },
                            ticks: {
                                color: 'rgba(16, 185, 129, 1)'
                            },
                            grid: {
                                drawOnChartArea: false, 
                            },
                        },
                    }
                }
            });
        }

        // --- Automatically load the data when the page is ready ---
        window.onload = loadStaticAvroFile;
    </script>
</body>
</html>
